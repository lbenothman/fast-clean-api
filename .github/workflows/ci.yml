name:
on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ main ]
permissions:
  contents: read
  packages: write
env:
  IMAGE_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  IMAGE_TAG_SHA: ${{ github.sha }}
  IMAGE_TAG_LATEST: latest
  APP_PORT: 8000

jobs:
  lint:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
      options: --user root
    defaults:
      run:
        working-directory: src/
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run ruff with uvx from PyPI
        run: |
          uvx --from ruff==0.12.0 ruff check .
      - name: Run mypy
        run: |
          uv sync --extra dev && uv run mypy . --explicit-package-bases

  build-and-test:
      runs-on: ubuntu-latest
      needs: lint

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build image
          run: |
            docker build -f docker/Dockerfile \
              -t $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG_SHA \
              -t $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG_LATEST \
              .

        - name: Run tests inside container
          run: |
            docker run --rm \
              -e DB_NAME=fast-clean-api \
              $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG_SHA \
              pytest -q

        - name: Run tests with coverage in container
          run: |
            docker run --name test-container \
              -e DB_NAME=fast-clean-api \
              $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG_SHA \
              pytest --cov=src/ --cov-report=xml --cov-report=html --cov-report=term-missing

        - name: Push images (only on main)
          if: github.ref == 'refs/heads/main'
          run: |
            docker push $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG_SHA
            docker push $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG_LATEST